# PypIt reduction rules.
[rdx]
    # Spectrograph that provided the data to be reduced.  Options are:
    # keck_lris_blue, keck_lris_red, keck_deimos, keck_nirspec,
    # shane_kast_blue, shane_kast_red, shane_kast_red_ret,
    # wht_isis_blue, tng_dolores
    spectrograph = keck_lris_blue
    # Pipeline options that pypit can use for reductions.  Options are:
    # ARMS
    pipeline = ARMS
    # Number of CPUs to use (-1 means all bar one CPU, -2 means all bar
    # two CPUs)
    ncpus = 1
    # Restrict reduction to a single detector with this index
    detnum = None
    # Directory relative to calling directory to write science files.
    scidir = Science

# Parameters for the calibration algorithms
[calibrations]
    # Directory relative to calling directory to write master files.
    caldir = MF
    # Treatment of master frames.  Use None to select the default
    # behavior (which is?), 'reuse' to use any existing masters, and
    # 'force' to __only__ use master frames.  Options are: None, reuse,
    # force
    masters = None
    # If masters='force', this is the setup name to be used: e.g.,
    # C_02_aa .  The detector number is ignored but the other
    # information must match the Master Frames in the master frame
    # folder.
    setup = None
    # Trim the frame to isolate the data
    trim = True
    # Make a bad pixel mask? Bias frames must be provided.
    badpix = True
    # Parameters used to set the flat-field procedure
    [[flatfield]]
        # Frame to use for field flattening.  Options are: pixelflat,
        # pinhole, or a specified master calibration file.
        frame = /Users/westfall/Work/packages/PYPIT-development-suite/CALIBS/PYPIT_LRISb_pixflat_B400_2x2_15apr2015.fits.gz
        # Use the flat field to determine the spatial profile of each
        # slit.
        slitprofile = True
        # Method used to flat field the data; use None to skip flat-
        # fielding.  Options are: None, PolyScan, bspline
        method = bspline
        # Flat-field method parameters.  For 'PolyScan', set params =
        # order, numPixels, repeat ; for bspline, set params = spacing
        params = 20
        # Perform a simple 2D PCA on the echelle blaze fits if the value
        # of this argument is >1. The argument value is equal to the
        # number of PCA components. 0 means that no PCA will be
        # performed.  **This is only used with ARMED pipeline.
        twodpca = 0
    # The frames and combination rules for the bias correction
    [[biasframe]]
        # Frame type.  Options are: bias, pixelflat, arc, pinhole,
        # trace, standard, science
        frametype = bias
        # A master calibrations file to use if it exists.
        useframe = overscan
        # Number of frames to use of this type
        number = 0
        # Parameters used when combining frames of this type
        [[[combine]]]
            # Match frames with pixel counts that are within N-sigma of
            # one another, where match=N below.  If N < 0, nothing is
            # matched.
            match = -1
            # Method used to combine frames.  Options are: mean, median,
            # weightmean
            method = mean
            # Handling of saturated pixels.  Options are: reject, force,
            # nothing
            satpix = reject
            # Sigma level to reject cosmic rays (<= 0.0 means no CR
            # removal)
            cosmics = 20.0
            # Number of pixels to reject at the lowest and highest ends
            # of the distribution; i.e., n_lohi = low, high.  Use None
            # for no limit.
            n_lohi = 0, 0
            # Sigma-clipping level at the low and high ends of the
            # distribution; i.e., sig_lohi = low, high.  Use None for no
            # limit.
            sig_lohi = 3.0, 3.0
            # If all pixels are rejected, replace them using this
            # method.  Options are: min, max, mean, median, weightmean,
            # maxnonsat
            replace = maxnonsat
        # Parameters used for cosmic ray detection for frames of this
        # type
        [[[lacosmic]]]
            # Maximum number of iterations.
            maxiter = 1
            # Factor by which to expand regions with detected cosmic
            # rays.
            grow = 1.5
            # Remove compact detections
            rmcompact = True
            # Sigma level for rejection
            sigclip = 5.0
            # Fraction for the lower clipping threshold.
            sigfrac = 0.3
            # Object detection limit
            objlim = 5.0
    # The frames and combination rules for the wavelength calibration
    [[arcframe]]
        # Frame type.  Options are: bias, pixelflat, arc, pinhole,
        # trace, standard, science
        frametype = arc
        # A master calibrations file to use if it exists.
        useframe = None
        # Number of frames to use of this type
        number = 1
        # Parameters used when combining frames of this type
        [[[combine]]]
            # Match frames with pixel counts that are within N-sigma of
            # one another, where match=N below.  If N < 0, nothing is
            # matched.
            match = -1
            # Method used to combine frames.  Options are: mean, median,
            # weightmean
            method = mean
            # Handling of saturated pixels.  Options are: reject, force,
            # nothing
            satpix = reject
            # Sigma level to reject cosmic rays (<= 0.0 means no CR
            # removal)
            cosmics = 20.0
            # Number of pixels to reject at the lowest and highest ends
            # of the distribution; i.e., n_lohi = low, high.  Use None
            # for no limit.
            n_lohi = 0, 0
            # Sigma-clipping level at the low and high ends of the
            # distribution; i.e., sig_lohi = low, high.  Use None for no
            # limit.
            sig_lohi = 3.0, 3.0
            # If all pixels are rejected, replace them using this
            # method.  Options are: min, max, mean, median, weightmean,
            # maxnonsat
            replace = maxnonsat
        # Parameters used for cosmic ray detection for frames of this
        # type
        [[[lacosmic]]]
            # Maximum number of iterations.
            maxiter = 1
            # Factor by which to expand regions with detected cosmic
            # rays.
            grow = 1.5
            # Remove compact detections
            rmcompact = True
            # Sigma level for rejection
            sigclip = 5.0
            # Fraction for the lower clipping threshold.
            sigfrac = 0.3
            # Object detection limit
            objlim = 5.0
    # The frames and combination rules for the field flattening
    [[pixelflatframe]]
        # Frame type.  Options are: bias, pixelflat, arc, pinhole,
        # trace, standard, science
        frametype = pixelflat
        # A master calibrations file to use if it exists.
        useframe = None
        # Number of frames to use of this type
        number = 1
        # Parameters used when combining frames of this type
        [[[combine]]]
            # Match frames with pixel counts that are within N-sigma of
            # one another, where match=N below.  If N < 0, nothing is
            # matched.
            match = -1
            # Method used to combine frames.  Options are: mean, median,
            # weightmean
            method = mean
            # Handling of saturated pixels.  Options are: reject, force,
            # nothing
            satpix = reject
            # Sigma level to reject cosmic rays (<= 0.0 means no CR
            # removal)
            cosmics = 20.0
            # Number of pixels to reject at the lowest and highest ends
            # of the distribution; i.e., n_lohi = low, high.  Use None
            # for no limit.
            n_lohi = 0, 0
            # Sigma-clipping level at the low and high ends of the
            # distribution; i.e., sig_lohi = low, high.  Use None for no
            # limit.
            sig_lohi = 3.0, 3.0
            # If all pixels are rejected, replace them using this
            # method.  Options are: min, max, mean, median, weightmean,
            # maxnonsat
            replace = maxnonsat
        # Parameters used for cosmic ray detection for frames of this
        # type
        [[[lacosmic]]]
            # Maximum number of iterations.
            maxiter = 1
            # Factor by which to expand regions with detected cosmic
            # rays.
            grow = 1.5
            # Remove compact detections
            rmcompact = True
            # Sigma level for rejection
            sigclip = 5.0
            # Fraction for the lower clipping threshold.
            sigfrac = 0.3
            # Object detection limit
            objlim = 5.0
    # The frames and combination rules for images used for slit tracing
    [[traceframe]]
        # Frame type.  Options are: bias, pixelflat, arc, pinhole,
        # trace, standard, science
        frametype = trace
        # A master calibrations file to use if it exists.
        useframe = None
        # Number of frames to use of this type
        number = 3
        # Parameters used when combining frames of this type
        [[[combine]]]
            # Match frames with pixel counts that are within N-sigma of
            # one another, where match=N below.  If N < 0, nothing is
            # matched.
            match = -1
            # Method used to combine frames.  Options are: mean, median,
            # weightmean
            method = mean
            # Handling of saturated pixels.  Options are: reject, force,
            # nothing
            satpix = reject
            # Sigma level to reject cosmic rays (<= 0.0 means no CR
            # removal)
            cosmics = 20.0
            # Number of pixels to reject at the lowest and highest ends
            # of the distribution; i.e., n_lohi = low, high.  Use None
            # for no limit.
            n_lohi = 0, 0
            # Sigma-clipping level at the low and high ends of the
            # distribution; i.e., sig_lohi = low, high.  Use None for no
            # limit.
            sig_lohi = 3.0, 3.0
            # If all pixels are rejected, replace them using this
            # method.  Options are: min, max, mean, median, weightmean,
            # maxnonsat
            replace = maxnonsat
        # Parameters used for cosmic ray detection for frames of this
        # type
        [[[lacosmic]]]
            # Maximum number of iterations.
            maxiter = 1
            # Factor by which to expand regions with detected cosmic
            # rays.
            grow = 1.5
            # Remove compact detections
            rmcompact = True
            # Sigma level for rejection
            sigclip = 5.0
            # Fraction for the lower clipping threshold.
            sigfrac = 0.3
            # Object detection limit
            objlim = 5.0
    # Parameters used to derive the wavelength solution
    [[wavelengths]]
        # Method to use to fit the individual arc lines.  'fit' is
        # likely more accurate, but 'simple' uses a polynomial fit (to
        # the log of a gaussian) and is fast and reliable.  'arclines'
        # uses the arclines python package.Options are: simple, fit,
        # arclines
        method = arclines
        # Name of one or more ions used for the wavelength calibration.
        # Use None for no calibration.  Options are: ArI, CdI, HgI, HeI,
        # KrI, NeI, XeI, ZnI, ThAr
        lamps = None
        # Detection threshold for arc lines (in standard deviation)
        detection = 6.0
        # Number of brightest arc lines to search for in preliminary
        # identification
        numsearch = 20
        # Number of pixels to fit when deriving the centroid of the arc
        # lines (an odd number is best)
        nfitpix = 5
        # One or more pixels at which to manually identify a line
        IDpixels = None
        # Wavelengths of the manually identified lines
        IDwaves = None
    # Define how the slits should be traced using the trace ?PINHOLE?
    # frames
    [[slits]]
        # Function use to trace the slit center.  Options are:
        # polynomial, legendre, chebyshev
        function = legendre
        # Order of the function to use.
        polyorder = 3
        # Number of times to median smooth a trace image prior to
        # analysis for slit/order edges
        medrep = 0
        # Manually set the number of slits to identify (>=1). 'auto' or
        # -1 will automatically identify the number of slits.
        number = -1
        # How much to trim off each edge of each slit
        trim = 3, 3
        # Maximum number of pixels to allow for the gap between slits.
        # Use None if the neighbouring slits are far apart or of similar
        # illumination.
        maxgap = None
        # Maximum shift in trace crude
        maxshift = 0.15
        # Integer number of pixels to consider beyond the slit edges.
        pad = 0
        # Sigma detection threshold for edge detection
        sigdetect = 20.0
        # If a slit spans less than this fraction over the spectral size
        # of the detector, it will be ignored (and reconstructed when/if
        # an 'order' PCA analysis is performed).
        fracignore = 0.01
        # Order of the 2D function used to fit the 2d solution for the
        # spatial size of all orders.
        diffpolyorder = 2
        # Add a single, user-defined slit based on its location on each
        # detector.  Syntax is a list of values, 2 per detector, that
        # define the slit according to column values.  The second value
        # (for the right edge) must be greater than 0 to be applied.
        # LRISr example: setting single = -1, -1, 7, 295 means the code
        # will skip the user-definition for the first detector but adds
        # one for the second.  None means no user-level slits defined.
        single = None
        # Mode for Sobel filtering.  Default is 'nearest' but the
        # developers find 'constant' works best for DEIMOS.
        sobel_mode = nearest
        # Parameters used for the PCA parameters in slit tracing
        [[[pca]]]
            # Select to perform the PCA using the pixel position
            # (pcatype=pixel) or by spectral order (pcatype=order).
            # Pixel positions can be used for multi-object spectroscopy
            # where the gap between slits is irregular.  Order is used
            # for echelle spectroscopy or for slits with separations
            # that are a smooth function of the slit number.
            pcatype = pixel
            # Order of the polynomials to be used to fit the principle
            # components.  TODO: Provide more explanation
            params = 3, 2, 1, 0, 0, 0
            # The number of extra orders to predict in the negative
            # (first number) and positive (second number) direction.
            # Must be two numbers in the list and they must be integers.
            extrapolate = 0, 0
    # Define how to tract the slit tilts using the trace frames
    [[tilts]]
        # Only use the arc lines that have an identified wavelength to
        # trace tilts
        idsonly = True
        # TODO: X fill in the doc for this
        tracethresh = 1000.0
        # Order of the polynomial function to be used for the tilt of an
        # individual arc line.  Must be 1 for eschelle data (ARMED
        # pipeline).
        order = 1
        # Type of function for arc line fits
        function = legendre
        # Order of the polynomial function to be used to fit the tilts
        # along the y direction.  TODO: Only used by ARMED pipeline?
        yorder = 1
        # Type of function for 2D fit
        func2D = legendre
        # Method used to trace the tilt of the slit along an order.
        # Options are: pca, spca, spline, interp, perp, zero
        method = spca
        # Parameters to use for the provided method.  TODO: Need more
        # explanation
        params = 1, 1, 1

# The frames and combination rules for the spectrophotometric standard
# observations
[standardframe]
    # Frame type.  Options are: bias, pixelflat, arc, pinhole, trace,
    # standard, science
    frametype = standard
    # A master calibrations file to use if it exists.
    useframe = None
    # Number of frames to use of this type
    number = 0
    # Parameters used when combining frames of this type
    [[combine]]
        # Match frames with pixel counts that are within N-sigma of one
        # another, where match=N below.  If N < 0, nothing is matched.
        match = -1
        # Method used to combine frames.  Options are: mean, median,
        # weightmean
        method = mean
        # Handling of saturated pixels.  Options are: reject, force,
        # nothing
        satpix = reject
        # Sigma level to reject cosmic rays (<= 0.0 means no CR removal)
        cosmics = 20.0
        # Number of pixels to reject at the lowest and highest ends of
        # the distribution; i.e., n_lohi = low, high.  Use None for no
        # limit.
        n_lohi = 0, 0
        # Sigma-clipping level at the low and high ends of the
        # distribution; i.e., sig_lohi = low, high.  Use None for no
        # limit.
        sig_lohi = 3.0, 3.0
        # If all pixels are rejected, replace them using this method.
        # Options are: min, max, mean, median, weightmean, maxnonsat
        replace = maxnonsat
    # Parameters used for cosmic ray detection for frames of this type
    [[lacosmic]]
        # Maximum number of iterations.
        maxiter = 1
        # Factor by which to expand regions with detected cosmic rays.
        grow = 1.5
        # Remove compact detections
        rmcompact = True
        # Sigma level for rejection
        sigclip = 5.0
        # Fraction for the lower clipping threshold.
        sigfrac = 0.3
        # Object detection limit
        objlim = 5.0

# The frames and combination rules for the science observations
[scienceframe]
    # Frame type.  Options are: bias, pixelflat, arc, pinhole, trace,
    # standard, science
    frametype = science
    # A master calibrations file to use if it exists.
    useframe = None
    # Number of frames to use of this type
    number = 0
    # Parameters used when combining frames of this type
    [[combine]]
        # Match frames with pixel counts that are within N-sigma of one
        # another, where match=N below.  If N < 0, nothing is matched.
        match = -1
        # Method used to combine frames.  Options are: mean, median,
        # weightmean
        method = mean
        # Handling of saturated pixels.  Options are: reject, force,
        # nothing
        satpix = reject
        # Sigma level to reject cosmic rays (<= 0.0 means no CR removal)
        cosmics = 20.0
        # Number of pixels to reject at the lowest and highest ends of
        # the distribution; i.e., n_lohi = low, high.  Use None for no
        # limit.
        n_lohi = 0, 0
        # Sigma-clipping level at the low and high ends of the
        # distribution; i.e., sig_lohi = low, high.  Use None for no
        # limit.
        sig_lohi = 3.0, 3.0
        # If all pixels are rejected, replace them using this method.
        # Options are: min, max, mean, median, weightmean, maxnonsat
        replace = maxnonsat
    # Parameters used for cosmic ray detection for frames of this type
    [[lacosmic]]
        # Maximum number of iterations.
        maxiter = 1
        # Factor by which to expand regions with detected cosmic rays.
        grow = 1.5
        # Remove compact detections
        rmcompact = True
        # Sigma level for rejection
        sigclip = 5.0
        # Fraction for the lower clipping threshold.
        sigfrac = 0.3
        # Object detection limit
        objlim = 5.0

# Define how to tract the slit tilts using the trace frames
[objects]
    # Function to use to trace the object in each slit.  Options are:
    # ['polynomial', 'legendre', 'chebyshev']
    function = legendre
    # Order of the function to use to fit the object trace in each slit
    order = 2
    # Algorithm to use for finding objects.Options are: standard,
    # nminima
    find = standard
    # Parameter for Gaussian smoothing when find=nminima.
    nsmooth = 3
    # Ignore any objects within xedge of the edge of the slit
    xedge = 0.03
    # Method to use for tracing each object; only used with ARMED
    # pipeline.  Options are: pca, spca, spline, interp, perp, zero
    method = pca
    # Parameters for the requested method.  For pca, params is a list
    # containing the order of the polynomials that should be used to fit
    # the object trace principal components. For example, params = 1, 0
    # will fit 2 principal components, the first PC will be fit with a
    # first order polynomial, the second PC will be fit with a zeroth
    # order polynomial. TODO: What about the other methods?
    params = 1, 0

# Define how to extract 1D object spectra
[extract]
    # If desired, a fits file can be specified (of the appropriate
    # form)to specify the locations of the pixels on the detector (in
    # physical space).  TODO: Where is "appropriate form" specified?
    pixelmap = None
    # The size of the extracted pixels (as an scaled number of Arc
    # FWHM), -1 will not resample
    pixelwidth = 2.5
    # If the extraction has previously been performed and saved, load
    # the previous result
    reuse = False
    # Fitting function used to extract science data, only if the
    # extraction is 2D.  NOTE: options with suffix 'func' fits a
    # function to the pixels whereas those without this suffix take into
    # account the integration of the function over the pixel (and is
    # closer to truth).   Options are: gaussian, gaussfunc, moffat,
    # moffatfunc
    profile = gaussian
    # Maximum number of objects to extract in a science frame.  Use None
    # for no limit.
    maxnumber = None
    # List of manual extraction parameter sets
    manual = None

# Parameters used to set the sky-subtraction procedure
[skysubtract]
    # Break-point spacing for the bspline fit
    bspline_spacing = 0.6

# Parameters used to set the flexure-correction procedure
[flexure]
    # Method used to correct for flexure. Use None for no correction.
    # If slitcen is used, the flexure correction is performed before the
    # extraction of objects.  Options are: None, boxcar, slitcen
    method = boxcar
    # Maximum allowed flexure shift in pixels.
    maxshift = 20
    # Archive sky spectrum to be used for the flexure correction.
    spectrum = sky_LRISb_400.fits

# Parameters used to set the wavelength calibration to provide for the
# output spectra
[wavecalib]
    # Medium used when wavelength calibrating the data.  Options are:
    # pixel, vacuum, air
    medium = vacuum
    # Frame of reference for the wavelength calibration.  Options are:
    # heliocentric, barycentric
    refframe = None

# Parameters used to set the flux-calibration procedure
[fluxcalib]
    # Flag to perform flux calibration
    flux = False
    # Perform a non-linear correction.  Requires a series of pixelflats
    # of the same lamp and setup and with a variety of exposure times
    # and count rates in every pixel.
    nonlinear = False
    # YAML file with an existing calibration function
    sensfunc = None
